<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
		<title>停车场</title>
		<!--<link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">-->
		<link rel="stylesheet" href="https://unpkg.com/mint-ui/lib/style.css">
		<!--<link rel="stylesheet" type="text/css" href="../fontawesome-free-5.2.0-web/css/fontawesome.css" />-->
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.1/css/all.css" integrity="sha384-O8whS3fhG2OnA5Kas0Y9l3cfpmYjapjI0E4theH4iuMD+pLhbf6JI0jIMfYcK3yZ" crossorigin="anonymous">
		
		<!--引入高德地图-->
		<link rel="stylesheet" href="https://cache.amap.com/lbs/static/main.css?v=1.0" />
		<!--<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/all.css" integrity="sha384-hWVjflwFxL6sNzntih27bfxkr27PmbbK/iSvJ+a4+0owXq79v+lsFkW54bOGbiDQ" crossorigin="anonymous">-->
		<!--<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/all.css" integrity="sha384-hWVjflwFxL6sNzntih27bfxkr27PmbbK/iSvJ+a4+0owXq79v+lsFkW54bOGbiDQ" crossorigin="anonymous">-->
		<link rel="stylesheet" type="text/css" href="../css/layoutcontanier.css" />
		<link rel="stylesheet" type="text/css" href="../css/layout.css" />
		<link rel="stylesheet" type="text/css" href="../css/common.css" />
		<link rel="stylesheet" type="text/css" href="../css/findCar.css" />
		<link rel="stylesheet" type="text/css" href="../css/head.css" />
		<style type="text/css">
			.el-main {
				text-align: left;
			}
			
			.staticbutton,
			.hotbotton {
				border-radius: 3px;
				background-color: white;
				outline: none;
				margin-right: 5px;
			}
			
			.staticbutton {
				border: 1px solid #1CA81B;
				color: #1CA81B;
			}
			
			.hotbotton {
				border: 1px solid red;
				color: red;
			}
			
			.el-button {
				padding: 5px 8px;
			}
			
			.el-button.is-round {
				padding: 6px 8px;
			}
			
			.margin-top-sty1 {
				margin-top: 5px;
			}
			
			.searchBox {
				line-height: 0;
				margin-bottom: 10px;
			}
			
			.el-autocomplete {
				width: 100%;
			}
			/*新增*/
			
			#chooseI {
				color: #D9D9D9;
				font-size: 20px;
			}
			
			.activeI i {
				color: #26A2FF;
				font-size: 20px;
			}
			
			.normalI i {
				color: #D9D9D9;
				font-size: 20px;
			}
			
			.cars-list {
				padding: 10px 15px;
				background-color: white;
				border-bottom: 1px solid #ECECEC;
				display: -webkit-flex;
				display: flex;
				flex-direction: row;
				flex-wrap: wrap;
				justify-content: space-between;
				align-items: center;
				align-content: flex-start;
				margin-bottom: 10px;
			}
			
			.grid-left-box {
				width: 80%;
			}
			
			.grid-right-box {
				width: 20%;
			}
			
			.p-style-1 {
				margin: 0;
				padding: 0;
			}
			
			.mint-search {
				height: 100%;
			}
			
			.item-carport-box{
				margin-top: ;
				width: 100%;
				border-top: 2px solid #ECECEC;
				padding: 5px 0;
			}
			.item-carport-box ul{
				overflow: hidden;
				margin: 0;
				padding: 0;
			}
			.item-carport-box ul li{
				float: left;
				height: 50px;
				list-style: none;
				overflow: hidden;
			}
			/*.item-carport-box ul li:nth-of-type(1){
				box-sizing: border-box;
				padding: 0 8px;
				text-align: center;
				border-right: 2px solid #5899F9;
				width: 20%;
				position: relative;
				display: table-cell;
				text-align: center;
				vertical-align: middle;
			}
			.item-carport-box ul li:nth-of-type(1) p{
				margin: 0;
				
			}*/
			.item-carport-box ul li:nth-of-type(1){
				position: relative;
				width: 80%;
			}
			.item-carport-box ul li:nth-of-type(1) div:nth-of-type(2){
				/*position: absolute;
				left: 0;
				bottom: 0;*/
			}
			.item-carport-box ul li:nth-of-type(2){
				width: 20%;
			}
			.item-carport-content{
				margin-top: 8px;
			}
			.item-carport-content p{
				margin: 0;
				font-size: 14px;
				font-weight: bold;
			}
			.booking-botton{
				float: right;
				margin-top: 8px;
			}
		</style>
	</head>

	<body>
		<div id="app">
			<div class="headerBox">
				<ul>
					<li>
						<i class="fal fa-angle-left"></i>
					</li>
					<li>车辆查找</li>
					<li></li>
				</ul>

			</div>

			<div>
				<mt-search @keyup.enter.native="searchPark" v-model="searchValue" cancel-text="取消" placeholder="搜索"></mt-search>
			</div>

			<div>
				<div class="cars-list" v-for="(item,index) in nearParks">
					<div class="grid-left-box">
						<p class='margin-left-style font-size-sty2 p-style-1'>{{item.name}}</p>

						<div class='font-size-1 margin-sty'>
							<button v-for="(itemtrait,index) in item.trait" v-bind:class="{ hotbotton: itemtrait.hot,  staticbutton: itemtrait.hot==false }">{{itemtrait.value}}</button>
						</div>

						<div class='margin-left-style font-size-sty3'>
							空 {{item.info.kongwei}} | 免费{{item.info.free}} | {{item.info.price}}元/小时
						</div>
						
					</div>
					<div class="grid-right-box">
						{{item.distance}}
						<div class='margin-top-sty1'>
							<a v-bind:href="'mapdemo.html?longt=' + item.longt + '&lat=' + item.lat">
								<mt-button type="primary" size='small'>前往</mt-button>
							</a>
						</div>

						
					</div>
					<div class="item-carport-box">
						<div class="item-carport-content" v-for="carportItem in item.allCarport">
							<p>{{carportItem.carportName}}</p>
							<ul>
								<!--<li><p>{{carportItem.carportName}}</p></li>-->
								<li>
									<div class='font-size-1 margin-sty'>
										<button v-for="(carporttrait,index) in carportItem.carportTrait" v-bind:class="{ hotbotton: carporttrait.hot,  staticbutton: carporttrait.hot==false }">{{carporttrait.value}}</button>
									</div>
			
									<div class='margin-left-style font-size-sty3'>
										空 {{carportItem.carportLeftSpace}} | {{carportItem.carportBillingSchemeStr}}元/小时
									</div>
									
								</li>
								<li>
									<div class='margin-top-sty1 booking-botton'>
										<a v-bind:href="'appointment.html?carportId=' + carportItem.carportId">
											<mt-button type="danger" size='small'>预约</mt-button>
										</a>
									</div>
								</li>
							</ul>
						</div>
					</div>
				</div>
			</div>

		</div>

		<script src="https://unpkg.com/vue/dist/vue.js" type="text/javascript" charset="utf-8"></script>
		<script src="https://unpkg.com/mint-ui/lib/index.js"></script>
		<!--高德地图-->
		<script type="text/javascript" src="https://webapi.amap.com/maps?v=1.4.8&key=21321a7e4734f283dbb81616b7a9da96&plugin=AMap.DistrictSearch"></script>
		<script type="text/javascript" src="https://webapi.amap.com/demos/js/liteToolbar.js"></script>
		<script src="../js/jquery.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
		<script src="../js/tyajax.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript">
			var ajaxDataFun = getAjaxData;
			var getParam = GetQueryString;
			var promptFun = promptBtnFun; //提示
			var getAwardIdFun = getAwardId; //获取活动的建立计划id
			var sessionFun = setcodeval; //添加session
			var getCode = getCode; //通过code获取用户信息
			var getuserInfo = getuserInfo; //通过openid获取用户信息

			//实现地图定位   start
			var map = new AMap.Map('', {
				resizeEnable: true
				//				center: [116.30946, 39.937629],
				//				zoom: 3
			});
			//实现地图定位   end

			var Main = {
				data() {
					return {
						styleObj: {
							color: "#D9D9D9",
							fontSize: "20px"
						},
						currentIndex: -1,
						staticClass: 'staticbutton',
						activeClass: 'hotbotton',
						nearParks: [],
						restaurants: [],
						state4: '',
						timeout: null,
						//搜索
						searchValue: '',
						currentLongt: '',
						currentLat: ''
					}
				},
				mounted: function() {
					this.restaurants = this.loadAll();
					this.$nextTick(function() {
						//加载完成执行
						var _this = this;
						//加载完成执行
						//高德地图进行定位
						//瀏覽器定位
						map.plugin('AMap.Geolocation', function() {
							geolocation = new AMap.Geolocation({
								enableHighAccuracy: true, //是否使用高精度定位，默认:true
								timeout: 10000, //超过10秒后停止定位，默认：无穷大
								buttonOffset: new AMap.Pixel(10, 20), //定位按钮与设置的停靠位置的偏移量，默认：Pixel(10, 20)
								zoomToAccuracy: true, //定位成功后调整地图视野范围使定位位置及精度范围视野内可见，默认：false
								buttonPosition: 'RB'
							});
							map.addControl(geolocation);
							geolocation.getCurrentPosition();
							AMap.event.addListener(geolocation, 'complete', onComplete); //返回定位信息
							AMap.event.addListener(geolocation, 'error', onError); //返回定位出错信息
						});
						//解析定位结果
						function onComplete(data) {
							console.log('定位结果')
							console.log(data)
							_this.currentLongt = data.position.getLng();
							_this.currentLat = data.position.getLat();
							console.log(_this.currentLongt);
							console.log(_this.currentLat)
							getCityCode(data.addressComponent.city)
						}
						//解析定位错误信息
						function onError(data) {
							promptFun("定位失败")
							//		        document.getElementById('tip').innerHTML = '定位失败';
						}

						//行政区划查询
						function getCityCode(x) {
							var opts = {
								subdistrict: 1, //返回下一级行政区
								level: 'city',
								showbiz: false //最后一级返回街道信息
							};
							district = new AMap.DistrictSearch(opts); //注意：需要使用插件同步下发功能才能这样直接使用
							district.search(x, function(status, result) {
								if(status == 'complete') {
									//获取停车场列表
									_this.getParkingList(result.districtList[0].adcode)
								}
							});
						}

					})
				},
				methods: {
					loadAll() {
						return [{
								"value": "三全鲜食（北新泾店）",
								"address": "长宁区新渔路144号"
							},
							{
								"value": "Hot honey 首尔炸鸡（仙霞路）",
								"address": "上海市长宁区淞虹路661号"
							},
							{
								"value": "新旺角茶餐厅",
								"address": "上海市普陀区真北路988号创邑金沙谷6号楼113"
							},
							{
								"value": "南拳妈妈龙虾盖浇饭",
								"address": "普陀区金沙江路1699号鑫乐惠美食广场A13"
							}
						];
					},
					querySearchAsync(queryString, cb) {
						var restaurants = this.restaurants;
						var results = queryString ? restaurants.filter(this.createStateFilter(queryString)) : restaurants;

						clearTimeout(this.timeout);
						this.timeout = setTimeout(() => {
							cb(results);
						}, 3000 * Math.random());
					},
					createStateFilter(queryString) {
						return(state) => {
							return(state.value.toLowerCase().indexOf(queryString.toLowerCase()) === 0);
						};
					},
					handleSelect(item) {
						
					},
					//选择一个停车场
					chooseParking: function(index) {
						this.currentIndex = index;
						
						//选中之后带上停车场id跳转回长租车页面
						window.location.href = "langcarrentl.html?parkingId=" + this.nearParks[index].parkingId + "&parkingName=" + this.nearParks[index].name;
					},
					//通过搜索获取停车场列表
					searchPark: function(e) {
						var _this = this ;
						_this.nearParks = [];
						var keyCode = window.event ? e.keyCode : e.which;
						if(keyCode == 13 && this.searchValue) {
							//调用搜索停车场的接口 
							axios.get(baseUrl + '/api/parkinglot/search/nearby', {params:{
									longitude: _this.currentLongt,
									latitude: _this.currentLat,
									distance: '200000',
									keyword: _this.searchValue
								}})
								.then(function(response) {
									console.log(response)
									if(response.status == 200){
										if(response.data.code==200){
											for(var i = 0; i < response.data.data.length; i++) {
												_this.getParkinglotList(response.data.data[i].name, response.data.data[i].id,response.data.data[i].longitude,response.data.data[i].latitude)
											}
										}else{
											//提示出错原因
										}
										
									}else{
										
									}
								})
								.catch(function(error) {
									alert(error);
								});

						}

					},
					//获取停车场列表
					getParkingList: function(c) {
						var _this = this;
						axios.get(baseUrl + '/api/parkinglot/list', {
								params: {
									areaCode: c
								}
							})
							.then(function(response) {
								if(response.status == 200 && response.data.code == 200) {
									//返回的链接加上parkingId的值
									//根据停车场获取所有的车库
									for(var i = 0; i < response.data.data.content.length; i++) {
										_this.getParkinglotList(response.data.data.content[i].name, response.data.data.content[i].id,response.data.data.content[i].longitude,response.data.data.content[i].latitude)
									}
								}

							})
							.catch(function(error) {

							})
					},
					//获取车库列表
					getParkinglotList: function(name, id ,longt ,lat) {
						var _this = this;
						axios.get(baseUrl + '/api/parkinglot/garage/list', {
								params: {
									parkingLotId: id
								}
							})
							.then(function(response) {
								//展示所有停车场    只有可以预约的停车场显示预约按钮
								if(response.status == 200 && response.data.code == 200) {
									var leftSpaceTotle=0,parkingLotTypeE,isRentableE,isTwentyFourHourE,isBookingE;
									var carportArr = [] , parkingLotType = [], isRentable = [], isTwentyFourHour = [], isBooking = []
									for(var i = 0; i < response.data.data.content.length; i++) {
										var carportTypeE = '';
										//空余车位总数
										leftSpaceTotle += parseFloat(response.data.data.content[i].leftSpace);
										//车库类型
										if(parkingLotType == '' || parkingLotType.indexOf(response.data.data.content[i].type) == -1) {
											parkingLotType.push(response.data.data.content[i].type);
										}
										//是否可租
										if(response.data.data.content[i].isRentable == true) {
											isRentable.push(response.data.data.content[i].isRentable)
										}
										//是否24小时停车
										if(response.data.data.content[i].isTwentyFourHour == true) {
											isTwentyFourHour.push(response.data.data.content[i].isTwentyFourHour)
										}
										//是否可预约
										if(response.data.data.content[i].isBooking == true) {
											isBooking.push(response.data.data.content[i].isBooking);
											//把每一个车库的信息添加到车库数组中
											if(response.data.data.content[i].type == 'GROUND'){
												carportTypeE = '地面';
											}else if(response.data.data.content[i].type == 'UNDERGROUND'){
												carportTypeE = '地下';
											}else if(response.data.data.content[i].type == 'SOLID'){
												carportTypeE = '立体';
											}else if(response.data.data.content[i].type == 'OTHER'){
												carportTypeE = '其他';
											}
											
											carportArr.push({
												carportId : response.data.data.content[i].id,//车库的id
												carportName:response.data.data.content[i].name,//车库名字
												carportLeftSpace : response.data.data.content[i].leftSpace,//车库剩余车位
//												carportType : response.data.data.content[i].type,//车库类型
//												carportIsTwentyFourHour : response.data.data.content[i].isTwentyFourHour,//是否支持24小时停车
//												carportIsRentable : response.data.data.content[i].isRentable,//是否可出租
//												carportIsBooking : response.data.data.content[i].isBooking,//是否可预约
												carportBillingSchemeStr : response.data.data.content[i].billingSchemeStr,//计费方式
												
												carportTrait:[{
													hot: response.data.data.content[i].isTwentyFourHour,
													value: '24小时'
												}, {
													hot: false,
													value: carportTypeE
												}, {
													hot: response.data.data.content[i].isBooking,
													value: '预约'
												}, {
													hot: response.data.data.content[i].isRentable,
													value: '出租'
												}]
											})
										}
									}
									
									setTimeout(function(){
										    if(isTwentyFourHour.length>0){
												isTwentyFourHourE = true;
											}else{
												isTwentyFourHourE = false ;
											}
											if(isBooking.length>0){
												isBookingE = true;
											}else{
												isBookingE = false;
											}
											if(parkingLotType.length>1){
												parkingLotTypeE = '混合式'
											}else if(parkingLotType.length==1){
												if(parkingLotType[0] == 'GROUND'){
													parkingLotTypeE = '地面';
												}else if(parkingLotType[0] == 'UNDERGROUND'){
													parkingLotTypeE = '地下';
												}else if(parkingLotType[0] == 'SOLID'){
													parkingLotTypeE = '立体';
												}else if(parkingLotType[0] == 'OTHER'){
													parkingLotTypeE = '其他';
												}
											}
										 },1)
										setTimeout(function(){
											_this.nearParks.push({
												parkingId: id,
												name: name,
												longt: longt,
												lat: lat,
												trait: [{
													hot: isTwentyFourHourE,
													value: '24小时'
												}, {
													hot: false,
													value: parkingLotTypeE
												}, {
													hot: isBookingE,
													value: '预约'
												}],
												distance: "560m",
												info: {
													kongwei: leftSpaceTotle,
													free: "1小时",
													price: 12
												},
												allCarport:carportArr
											})
										},2)
								}
							})
							.catch(function(error) {

							})
					}
				}
			};
			var Ctor = Vue.extend(Main)
			new Ctor().$mount('#app')
		</script>
	</body>

</html>